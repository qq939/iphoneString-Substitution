<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ComfyUI 任务状态判断与反馈流程</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 24px;
            background: #0f172a;
            color: #e5e7eb;
        }
        h1, h2 {
            margin: 0 0 16px 0;
        }
        h1 {
            font-size: 24px;
        }
        h2 {
            font-size: 18px;
            margin-top: 32px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            margin-bottom: 24px;
        }
        .flow-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 12px;
        }
        .node {
            background: #111827;
            border-radius: 8px;
            padding: 12px 16px;
            border: 1px solid #374151;
            min-width: 200px;
            position: relative;
        }
        .node-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .node-body {
            font-size: 12px;
            opacity: 0.9;
            line-height: 1.5;
        }
        .arrow {
            align-self: center;
            font-size: 18px;
            color: #9ca3af;
        }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            margin-right: 4px;
        }
        .badge-status {
            background: #1f2937;
            border: 1px solid #4b5563;
        }
        .badge-succeeded {
            background: #065f46;
            border: 1px solid #10b981;
            color: #d1fae5;
        }
        .badge-failed {
            background: #7f1d1d;
            border: 1px solid #ef4444;
            color: #fee2e2;
        }
        .badge-pending {
            background: #854d0e;
            border: 1px solid #f59e0b;
            color: #fef3c7;
        }
        .badge-running {
            background: #1d4ed8;
            border: 1px solid #3b82f6;
            color: #dbeafe;
        }
        .code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 11px;
            background: #020617;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .inline-code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 11px;
            background: #020617;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .status-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ComfyUI 任务状态判断与反馈流程</h1>
    <div class="section">
        <div>核心函数：<span class="inline-code">queue_prompt</span> + <span class="inline-code">check_status</span></div>
        <div class="status-legend">
            <span class="badge badge-succeeded">SUCCEEDED</span>
            <span class="badge badge-failed">FAILED</span>
            <span class="badge badge-pending">PENDING</span>
            <span class="badge badge-running">RUNNING</span>
        </div>
    </div>

    <div class="section">
        <h2>1. 提交任务 queue_prompt</h2>
        <div class="flow-row">
            <div class="node">
                <div class="node-title">构造请求</div>
                <div class="node-body">
                    <div class="code">queue_prompt(prompt)</div>
                    <div>包装为 JSON：</div>
                    <div class="code">{"prompt": workflow, "client_id": ...}</div>
                </div>
            </div>
            <div class="arrow">⟶</div>
            <div class="node">
                <div class="node-title">发送到 ComfyUI</div>
                <div class="node-body">
                    <div class="code">POST /prompt</div>
                    <div>成功返回：</div>
                    <div class="code">{"prompt_id": "..."} </div>
                </div>
            </div>
            <div class="arrow">⟶</div>
            <div class="node">
                <div class="node-title">记录任务</div>
                <div class="node-body">
                    <div>app 中保存：</div>
                    <div class="code">(prompt_id, server_address)</div>
                    <div>写入 <span class="inline-code">TASKS_STORE</span> / <span class="inline-code">AUDIO_TASKS</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>2. 任务轮询 check_status</h2>
        <div class="flow-row">
            <div class="node">
                <div class="node-title">选择服务器</div>
                <div class="node-body">
                    <div>入参：</div>
                    <div class="code">check_status(prompt_id, server_address=None)</div>
                    <div>逻辑：</div>
                    <div>- 有 server_address：只查这一台</div>
                    <div>- 否则遍历 SERVER_LIST</div>
                </div>
            </div>
            <div class="arrow">⟶</div>
            <div class="node">
                <div class="node-title">查询 history</div>
                <div class="node-body">
                    <div class="code">GET /history/&lt;prompt_id&gt;</div>
                    <div>- 有数据且包含该 id：</div>
                    <div> 解析 outputs，选出最佳文件</div>
                    <div> <span class="badge badge-succeeded">返回 SUCCEEDED</span></div>
                    <div>- 返回 None：记为网络错误</div>
                </div>
            </div>
            <div class="arrow">⟶</div>
            <div class="node">
                <div class="node-title">查询 queue</div>
                <div class="node-body">
                    <div class="code">GET /queue</div>
                    <div>- 在 pending/running 队列里：</div>
                    <div> <span class="badge badge-running">RUNNING</span> 或 <span class="badge badge-pending">PENDING</span></div>
                    <div>- 状态 UNKNOWN：</div>
                    <div> 记为网络错误</div>
                    <div>- NOT_FOUND 且刚查过 history：</div>
                    <div> 再试一次 history</div>
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>3. 最终状态判定</h2>
        <div class="flow-row">
            <div class="node">
                <div class="node-title">有任一服务器 SUCCEEDED</div>
                <div class="node-body">
                    <div>立即返回：</div>
                    <div class="code">("SUCCEEDED", file_info)</div>
                    <div>上层逻辑：</div>
                    <div>- 下载结果文件</div>
                    <div>- 拼接视频 / 上传 OBS</div>
                </div>
            </div>
            <div class="arrow">⟶</div>
            <div class="node">
                <div class="node-title">有网络错误</div>
                <div class="node-body">
                    <div>所有服务器都查完后：</div>
                    <div>- 只要出现过网络异常</div>
                    <div> <span class="badge badge-pending">返回 PENDING</span></div>
                    <div>- 避免把网络抖动当成任务 FAILED</div>
                </div>
            </div>
            <div class="arrow">⟶</div>
            <div class="node">
                <div class="node-title">无输出且无网络错误</div>
                <div class="node-body">
                    <div>条件：</div>
                    <div>- history 无该 id</div>
                    <div>- queue 中也不存在</div>
                    <div>- 没有网络异常</div>
                    <div>最终：</div>
                    <div class="badge badge-failed">返回 FAILED</div>
                    <div class="code">("FAILED", "Task not found")</div>
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>4. app 层如何使用状态</h2>
        <div class="flow-row">
            <div class="node">
                <div class="node-title">视频分段任务</div>
                <div class="node-body">
                    <div>循环各段：</div>
                    <div class="code">status, result = check_status(task_id, server)</div>
                    <div>- SUCCEEDED: 下载到 result_path，标记 completed</div>
                    <div>- FAILED: 标记 failed，记录 error</div>
                    <div>- PENDING/RUNNING: 保持未完成状态</div>
                </div>
            </div>
            <div class="arrow">⟶</div>
            <div class="node">
                <div class="node-title">音频任务</div>
                <div class="node-body">
                    <div>轮询：</div>
                    <div class="code">check_status(prompt_id, server)</div>
                    <div>- SUCCEEDED: 下载音频，转 wav，上传 OBS</div>
                    <div>- 然后触发数字人视频生成</div>
                </div>
            </div>
            <div class="arrow">⟶</div>
            <div class="node">
                <div class="node-title">对外接口反馈</div>
                <div class="node-body">
                    <div>HTTP 接口返回：</div>
                    <div>- group: status + final_url</div>
                    <div>- audio: status + url</div>
                    <div>状态直接映射：</div>
                    <div>- completed / failed / processing</div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>

