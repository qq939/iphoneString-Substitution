<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hacker Grid</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="grid-container">
        <!-- 格子 1 -->
        <div class="grid-item item-1">
            <div class="grid-controls">
                <button class="control-btn control-btn-full" onclick="goFullscreen(this.closest('.grid-item'))">[FULL]</button>
                <button class="control-btn control-btn-back" onclick="exitFullscreen(this.closest('.grid-item'))">[BACK]</button>
            </div>
            <div class="grid-content">
                <h2>字符替换</h2>
                <form method="POST" action="/">
                    <div class="input-group">
                        <input type="text" name="text" placeholder=">_" autocomplete="off" autofocus>
                        <button type="submit" name="action" value="add">+</button>
                        <button type="submit" name="action" value="remove">-</button>
                    </div>
                </form>
                <div class="output-area">
                    <h3>BUFFER:</h3>
                    <div class="substitution-content">
                        {{ substitutions }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 格子 2: 角色上传 (原 Grid 4) -->
        <div class="grid-item item-2">
            <div class="grid-controls">
                <button class="control-btn control-btn-full" onclick="goFullscreen(this.closest('.grid-item'))">[FULL]</button>
                <button class="control-btn control-btn-back" onclick="exitFullscreen(this.closest('.grid-item'))">[BACK]</button>
            </div>
            <div class="grid-content">
                <h2>角色配置</h2>
                <form id="charUploadForm" action="/upload_character" method="post" enctype="multipart/form-data">
                    <input type="file" name="image" accept="image/png, image/jpeg, image/webp" 
                           class="upload-input">
                    <button type="submit" id="charUploadBtn" class="action-btn">UPLOAD CHARACTER</button>
                </form>
                <div id="charStatus" style="margin-top: 5px; font-size: 0.7em; white-space: pre-wrap;"></div>
            </div>
        </div>

        <!-- 格子 3: 结果展示 & 角色预览 -->
        <div class="grid-item item-3">
            <div class="grid-controls">
                <button class="control-btn control-btn-full" onclick="goFullscreen(this.closest('.grid-item'))">[FULL]</button>
                <button class="control-btn control-btn-back" onclick="exitFullscreen(this.closest('.grid-item'))">[BACK]</button>
            </div>
            <div class="grid-content">
                <span class="placeholder">SECTOR 03</span>
                <div id="outputContainer" style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <!-- Character Preview (Initially Hidden) -->
                    <img id="charPreview" src="http://obs.dimond.top/character.png" 
                         style="max-width: 90%; max-height: 90%; border: 1px solid #00ff00; object-fit: contain; display: none;"
                         onload="this.style.display='block'"
                         onerror="this.style.display='none'">
                    <!-- Video Output will be injected here via JS -->
                </div>
            </div>
        </div>

        <!-- 格子 4: 空 (原 Grid 4 移走了) -->
        <div class="grid-item item-4">
            <div class="grid-controls">
                <button class="control-btn control-btn-full" onclick="goFullscreen(this.closest('.grid-item'))">[FULL]</button>
                <button class="control-btn control-btn-back" onclick="exitFullscreen(this.closest('.grid-item'))">[BACK]</button>
            </div>
            <div class="grid-content">
                <span class="placeholder">SECTOR 04</span>
            </div>
        </div>

        <!-- 格子 5 -->
        <div class="grid-item item-5">
            <div class="grid-controls">
                <button class="control-btn control-btn-full" onclick="goFullscreen(this.closest('.grid-item'))">[FULL]</button>
                <button class="control-btn control-btn-back" onclick="exitFullscreen(this.closest('.grid-item'))">[BACK]</button>
            </div>
            <div class="grid-content">
                <span class="placeholder">SECTOR 05</span>
            </div>
        </div>

        <!-- 格子 6: 视频切片换人 (原 Grid 2) -->
        <div class="grid-item item-6">
            <div class="grid-controls">
                <button class="control-btn control-btn-full" onclick="goFullscreen(this.closest('.grid-item'))">[FULL]</button>
                <button class="control-btn control-btn-back" onclick="exitFullscreen(this.closest('.grid-item'))">[BACK]</button>
            </div>
            <div class="grid-content">
                <h2>视频切片换人 <span id="comfyStatusDot" style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: gray; margin-left: 10px; box-shadow: 0 0 2px gray;"></span></h2>
                <form id="uploadForm" action="/upload_and_cut" method="post" enctype="multipart/form-data">
                    <input type="file" name="video" accept="video/*" class="upload-input">
                    <button type="submit" id="uploadBtn" class="action-btn">EXECUTE</button>
                </form>
                <div id="uploadStatus" style="margin-top: 10px; font-size: 0.8em; white-space: pre-wrap; word-break: break-all;"></div>
            </div>
        </div>

        <!-- 其他格子占位 -->
        {% for i in range(7, 17) %}
        <div class="grid-item item-{{ i }}">
            <div class="grid-controls">
                <button class="control-btn control-btn-full" onclick="goFullscreen(this.closest('.grid-item'))">[FULL]</button>
                <button class="control-btn control-btn-back" onclick="exitFullscreen(this.closest('.grid-item'))">[BACK]</button>
            </div>
            <div class="grid-content">
                <span class="placeholder">SECTOR {{ "%02d"|format(i) }}</span>
            </div>
        </div>
        {% endfor %}
    </div>

    <script>
        // Fullscreen Logic
        function goFullscreen(elem) {
            elem.classList.add('fullscreen');
        }

        function exitFullscreen(elem) {
            elem.classList.remove('fullscreen');
        }

        // Check ComfyUI Status
        function checkComfyStatus() {
            fetch('/comfy_status')
                .then(response => response.json())
                .then(data => {
                    const dot = document.getElementById('comfyStatusDot');
                    if (data.connected) {
                        dot.style.backgroundColor = '#00ff00'; // Green
                        dot.style.boxShadow = '0 0 5px #00ff00';
                    } else {
                        dot.style.backgroundColor = '#ff0000'; // Red
                        dot.style.boxShadow = '0 0 5px #ff0000';
                    }
                })
                .catch(err => {
                    console.error('Status check failed:', err);
                    const dot = document.getElementById('comfyStatusDot');
                    dot.style.backgroundColor = 'gray';
                });
        }
        
        // Check immediately and then every 30 seconds
        checkComfyStatus();
        setInterval(checkComfyStatus, 30000);

        // Character Upload Handler
        document.getElementById('charUploadForm').onsubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const statusDiv = document.getElementById('charStatus');
            const btn = document.getElementById('charUploadBtn');
            const preview = document.getElementById('charPreview');
            
            statusDiv.innerText = 'UPLOADING...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/upload_character', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (response.ok) {
                    statusDiv.innerText = 'UPLOAD SUCCESS.';
                    // Update preview with cache busting
                    if (preview) {
                        preview.src = result.url + '?t=' + new Date().getTime();
                        preview.style.display = 'block';
                    }
                } else {
                    statusDiv.innerText = 'ERROR: ' + (result.error || 'Unknown');
                }
            } catch (err) {
                statusDiv.innerText = 'SYSTEM FAILURE: ' + err.message;
            } finally {
                btn.disabled = false;
            }
        };

        // Video Upload Handler
        document.getElementById('uploadForm').onsubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const statusDiv = document.getElementById('uploadStatus');
            const btn = document.getElementById('uploadBtn');
            
            statusDiv.innerText = 'INITIALIZING UPLOAD...\nTARGET: COMFYUI NODE';
            btn.disabled = true;
            
            try {
                const response = await fetch('/upload_and_cut', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (response.ok) {
                     statusDiv.innerText = 'UPLOAD SUCCESS. PROCESSING SEQUENCE INITIATED...';
                     
                     // Start polling
                     const groupId = result.group_id;
                     const pollInterval = setInterval(async () => {
                         try {
                             const statusRes = await fetch(`/check_group_status/${groupId}`);
                             const statusData = await statusRes.json();
                             
                             if (statusData.status === 'processing') {
                                 statusDiv.innerText = `PROCESSING... [${statusData.progress}]`;
                             } else if (statusData.status === 'completed') {
                                 clearInterval(pollInterval);
                                statusDiv.innerText = 'SEQUENCE COMPLETED.\nESTABLISHING LINK TO SECTOR 03...';
                                btn.disabled = false;
                                
                                // Display video in Sector 03 (replacing character preview or appending?)
                                // Request says Grid 3 should display the result. 
                                // We can replace the content of outputContainer or hide charPreview.
                                const outputContainer = document.getElementById('outputContainer');
                                const charPreview = document.getElementById('charPreview');
                                if (charPreview) charPreview.style.display = 'none'; // Hide char preview
                                
                                // Remove old video if exists
                                const oldVideo = outputContainer.querySelector('video');
                                if (oldVideo) oldVideo.remove();
                                
                                const videoContainer = document.createElement('div');
                                videoContainer.innerHTML = `
                                    <h2>OUTPUT FEED</h2>
                                    <video controls autoplay loop style="width: 100%; max-height: 200px; border: 1px solid #00ff00; background: #000;">
                                        <source src="${statusData.final_url}" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                    <div style="margin-top: 5px; font-size: 0.7em; word-break: break-all;">${statusData.final_url}</div>
                                `;
                                outputContainer.appendChild(videoContainer);
                                
                            } else {
                                 clearInterval(pollInterval);
                                 statusDiv.innerText = 'FAILED: ' + (statusData.error || 'Unknown error');
                                 btn.disabled = false;
                             }
                         } catch (e) {
                             console.error(e);
                             // Don't stop polling on transient network errors, but maybe show warning?
                         }
                     }, 2000);
                     
                 } else {
                     statusDiv.innerText = 'ERROR: ' + (result.error || 'Unknown');
                     btn.disabled = false;
                 }
             } catch (err) {
                 statusDiv.innerText = 'SYSTEM FAILURE: ' + err.message;
                 btn.disabled = false;
             }
         };
    </script>
</body>
</html>
